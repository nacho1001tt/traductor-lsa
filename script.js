// ==========================================================
// ==============  Traductor Voz/Text ‚Üí Se√±as  ==============
// ==========================================================

// Capturamos los elementos del HTML
const boton = document.getElementById('start');
const texto = document.getElementById('texto');
const videoSe√±a = document.getElementById('videoSe√±a');
const videoSource = document.getElementById('videoSource');
const entradaTexto = document.getElementById('entradaTexto');
const startText = document.getElementById('startText'); // Texto del bot√≥n

// Ocultar el video al cargar la p√°gina
videoSe√±a.style.display = "none";

// Configuramos el reconocimiento de voz
const reconocimiento = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
reconocimiento.lang = 'es-ES'; // Idioma espa√±ol

boton.addEventListener('click', () => {
    activarMicrofono();                    
    if (startText) startText.textContent = "Escuchando..."; 
    reconocimiento.start();                
});

reconocimiento.onresult = (event) => {
    const speechText = event.results[0][0].transcript.toLowerCase();
    mostrarTextoReconocido(speechText);
    procesarTextoSecuencial(speechText);
};

reconocimiento.onend = () => {
    desactivarMicrofono();
    if (startText) startText.textContent = "Hablar"; 
};

entradaTexto.addEventListener('keypress', (event) => {
    if (event.key === 'Enter') {
        event.preventDefault();
        const userInput = entradaTexto.value.toLowerCase();
        mostrarTextoReconocido(userInput);
        procesarTextoSecuencial(userInput);
    }
});

// ==========================================================
// ===============  Conjugaciones por verbo  =================
// ==========================================================
const conjugaciones = {
    dialogar: ["dialogar","dialogo","dialog√°s","dialogas","dialoga","dialogamos","dialogan","dialogu√©","dialogaste","dialog√≥","dialogamos","dialogaron","dialogaba","dialogabas","dialog√°bamos","dialogaban","dialogar√©","dialogar√°s","dialogar√°","dialogaremos","dialogar√°n","dialogar√≠a","dialogar√≠as","dialogar√≠amos","dialogar√≠an","dialogando","dialogado","he dialogado","hemos dialogado","han dialogado"],
    hablar: ["hablar","hablo","habl√°s","hablas","habla","hablamos","hablan","habl√©","hablaste","habl√≥","hablamos","hablaron","hablaba","hablabas","habl√°bamos","hablaban","hablar√©","hablar√°s","hablar√°","hablaremos","hablar√°n","hablar√≠a","hablar√≠as","hablar√≠amos","hablar√≠an","hablando","hablado","he hablado","hemos hablado","han hablado"],
    decir: ["decir","digo","dec√≠s","dices","dice","decimos","dicen","dije","dijiste","dijo","dijimos","dijeron","dec√≠a","dec√≠as","dec√≠amos","dec√≠an","dir√©","dir√°s","dir√°","diremos","dir√°n","dir√≠a","dir√≠as","dir√≠amos","dir√≠an","diciendo","dicho","he dicho","hemos dicho","han dicho"],
    contar: ["contar","cuento","cont√°s","contas","cuenta","contamos","cuentan","cont√©","contaste","cont√≥","contamos","contaron","contaba","contabas","cont√°bamos","contaban","contar√©","contar√°s","contar√°","contaremos","contar√°n","contar√≠a","contar√≠as","contar√≠amos","contar√≠an","contando","contado","he contado","hemos contado","han contado"],
    narrar: ["narrar","narro","narr√°s","narras","narra","narramos","narran","narr√©","narraste","narr√≥","narramos","narraron","narraba","narrabas","narr√°bamos","narraban","narrar√©","narrar√°s","narrar√°","narraremos","narrar√°n","narrando","narrado","he narrado","hemos narrado","han narrado"],
    explicar: ["explicar","explico","explic√°s","explicas","explica","explicamos","explican","expliqu√©","explicaste","explic√≥","explicamos","explicaron","explicaba","explicabas","explic√°bamos","explicaban","explicar√©","explicar√°s","explicar√°","explicaremos","explicar√°n","explicando","explicado","he explicado","hemos explicado","han explicado"],
    estar: ["estar","estoy","est√°s","est√°","estamos","est√°n","estuve","estuviste","estuvo","estuvimos","estuvieron","estaba","estabas","est√°bamos","estaban","estar√©","estar√°s","estar√°","estaremos","estar√°n","estando","estado","he estado","hemos estado","han estado"],
    apurar: ["apurar","apuro","apur√°s","apuras","apura","apuramos","apuran","apur√©","apuraste","apur√≥","apuramos","apuraron","apuraba","apurabas","apur√°bamos","apuraban","apurar√©","apurar√°s","apurar√°","apuraremos","apurar√°n","apurar√≠a","apurar√≠as","apurar√≠amos","apurar√≠an","apurando","apurado","he apurado","hemos apurado","han apurado"],
    llegar: ["llegar","llego","lleg√°s","llegas","llega","llegamos","llegan","llegu√©","llegaste","lleg√≥","llegamos","llegaron","llegaba","llegabas","lleg√°bamos","llegaban","llegar√©","llegar√°s","llegar√°","llegaremos","llegar√°n","llegar√≠a","llegar√≠as","llegar√≠amos","llegar√≠an","llegando","llegado","he llegado","hemos llegado","han llegado"]
};

// ==========================================================
// ==================  Palabras fijas  =======================
// ==========================================================
const palabrasFijas = {
    "lengua oral":"Lengua oral", "si":"Si","s√≠":"Si","no":"No","negar":"Negar",
    "tambi√©n":"Tambien","tambien":"Tambien","tampoco":"Tampoco","yo":"Yo","vos":"Vos","ustedes":"Ustedes",
    "el":"El o Ella","ella":"El o Ella","nosotros":"Nosotros o Nosotras","nosotras":"Nosotros o Nosotras",
    "ayer":"ayer","hoy":"hoy","ma√±ana":"ma√±ana","manana":"ma√±ana","a√±o":"a√±o","ano":"a√±o",
    "a√±o pasado":"a√±o pasado","ano pasado":"a√±o pasado","futuro":"futuro","pasado":"pasado",
    "√∫ltimo":"ultimo","ultimo":"ultimo","minuto":"minuto","hora":"hora","mes":"mes","semana":"semana",
    "domingo":"domingo","lunes":"lunes","martes":"martes","mi√©rcoles":"miercoles","miercoles":"miercoles",
    "jueves":"jueves","viernes":"viernes","s√°bado":"sabado","sabado":"sabado","mediod√≠a":"mediodia","mediodia":"mediodia",
    "todav√≠a":"todavia","todavia":"todavia","siempre":"siempre","r√°pido":"rapido","rapido":"rapido",
    "despacio":"despacio","temprano":"temprano","tarde":"tarde","hasta":"hasta","cerca":"cerca",
    "derecha":"derecha","izquierda":"izquierda","importante":"importante","limpio":"limpio",
    "hola":"hola"
};

// ==========================================================
// =========  Procesamiento secuencial (con frases) =========
// ==========================================================
function procesarTextoSecuencial(text){
    const palabras = text.split(" ");
    const videosAReproducir = [];

    // Frases fijas
    const frases = [
        ["como estas","Palabras/comoestas.mp4"],
        ["c√≥mo est√°s","Palabras/comoestas.mp4"],
        ["vos c√≥mo te llamas","Palabras/comotellamas.mp4"],
        ["c√≥mo te llamas","Palabras/comotellamas.mp4"],
        ["me llamo luana","Palabras/llamoluana.mp4"],
        ["como quieres","Palabras/como quieres.mp4"],
        ["lo siento","Palabras/lo siento.mp4"],
        ["hace poco","Palabras/hace poco.mp4"],
        ["a veces","Palabras/a veces.mp4"],
        ["toda la noche","Palabras/toda la noche.mp4"],
        ["todos los dias","Palabras/todos los dias.mp4"],
        ["todos los d√≠as","Palabras/todos los dias.mp4"],
        ["primera vez","Palabras/primera vez.mp4"],
        ["a√±o pasado","Palabras/a√±o pasado.mp4"],
        ["ano pasado","Palabras/a√±o pasado.mp4"]
    ];

    for(let [frase, archivo] of frases){
        if(text.includes(frase)) videosAReproducir.push(archivo);
    }

    // Palabras individuales
    const letras = ["a","b","c","d","e","f","g","h","i","j","k","l","ll","m","n","√±","o","p","q","r","s","t","u","v","w","x","y","z","ch"];
    for(let palabra of palabras){
        palabra = palabra.trim();

        if(letras.includes(palabra)) videosAReproducir.push(`Palabras/letra${palabra.toUpperCase()}.mp4`);

        for(let verbo in conjugaciones){
            if(conjugaciones[verbo].includes(palabra)){
                const nombreArchivo = (verbo==="contar"||verbo==="narrar")?"Contar o Narrar":verbo.charAt(0).toUpperCase()+verbo.slice(1);
                videosAReproducir.push(`Palabras/${nombreArchivo}.mp4`);
                break;
            }
        }

        if(palabrasFijas[palabra]) videosAReproducir.push(`Palabras/${palabrasFijas[palabra]}.mp4`);

        if(palabra==="anteayer"||palabra==="antayer") videosAReproducir.push("Palabras/antayer.mp4");
    }

    reproducirSecuencialmente(videosAReproducir);
}

// ==========================================================
// ==============  Reproducci√≥n secuencial  =================
// ==========================================================
let currentSpeed = (()=>{const sc=document.getElementById("speedControl");const val=sc?parseFloat(sc.value):NaN;return Number.isFinite(val)?val:0.75;})();

function reproducirSecuencialmente(lista){
    if(lista.length===0){videoSe√±a.style.display="none";return;}
    const path = lista.shift();
    videoSource.src=path;
    videoSe√±a.load();
    videoSe√±a.style.display="block";
    videoSe√±a.playbackRate=currentSpeed;
    setTimeout(()=>videoSe√±a.play(),50); // üîπ fix Chrome/Edge
    videoSe√±a.onended=()=>setTimeout(()=>reproducirSecuencialmente(lista),100);
}

// ==========================================================
// =====================  Extras UI  ========================
// ==========================================================
const speedControl = document.getElementById("speedControl");
const speedValue = document.getElementById("speedValue");
if(speedValue && speedControl) speedValue.textContent=parseFloat(speedControl.value)+"x";
speedControl.addEventListener("input",()=>{
    currentSpeed=parseFloat(speedControl.value);
    videoSe√±a.playbackRate=currentSpeed;
    speedValue.textContent=currentSpeed+"x";
});

function activarMicrofono(){boton.classList.add("mic-active");}
function desactivarMicrofono(){boton.classList.remove("mic-active");}

function mostrarTextoReconocido(textoReconocido){
    texto.textContent=textoReconocido;
    texto.classList.add("glow");
    setTimeout(()=>texto.classList.remove("glow"),1000);
}

const contrastToggle = document.getElementById("contrastToggle");
contrastToggle.addEventListener("click",()=>document.body.classList.toggle("high-contrast"));
